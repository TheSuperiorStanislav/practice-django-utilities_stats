{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
<div class="container-fluid" style="margin-top: 1em;" align="center">
    {% if not is_stat_data_empty %}
    {% for field, years in stat_data.items  %}
        <h2>{{ field|format_field }}</h2> 
        <ul class="nav nav-pills">
            {% for year in years %}
            <li class="nav-item">
                <a class="nav-link text-white" data-toggle="pill" href="#{{ field }}_{{ year }}">{{ year }}</a>
            </li>
            {% endfor %}
        </ul>
        <div class="tab-content" style="margin-bottom: 1em;">
            {% for year, data in years.items %}
                <div class="tab-pane container-fluid bg-dark fade" id="{{ field }}_{{ year }}" style="padding: 1em .5em;">
                    <p>Avg: {{ data|get_item:'avg' }}</p>
                    <p>Sum: {{ data|get_item:'sum' }}</p>
                    <p>Max: {{ data|get_item:'max' }}</p>
                    <p>Min: {{ data|get_item:'min' }}</p>
                    <canvas id="{{ field }}_{{ year }}_visualization"></canvas>
                </div>
            {% endfor %}
        </div>
    {% endfor %}
    {% else %}
    <h2>No data to work with.</h2>
    <a href="{% url 'utilities:create' %}" class="btn btn-success" role="button">Add Entry</a>
    {% endif %}
</div>
<script type="text/javascript">
    $('document').ready(() => {
        $(".nav-item:first-child .nav-link").toggleClass("active")
        $(".tab-pane:first-child").toggleClass("active")
        $(".tab-pane:first-child").toggleClass("fade")

        const months = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
            ]

        const capitalize = (s) => {
            return s[0].toUpperCase() + s.slice(1);
        }

        const normalizeField = (field) => {
            return capitalize(field.replace(/_/g, ' ').replace('hws', 'HWS'))
        }

        const drawGraph = (ctx, data) => {
            new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: months,
                    datasets: [{
                        label: normalizeField(field),
                        data: data,
                        borderColor: '#FFF',
                        backgroundColor: 'rgba(0,102,204,0.25)',
                        fill: true,
                    }],
                },
                options: {
                    responsive: true,
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(tooltipItem, data) {
                                const value = tooltipItem.yLabel
                                if (value == 0){
                                    return "No data"
                                }
                                var label = data.datasets[tooltipItem.datasetIndex].label || '';

                                if (label) {
                                    label += ': ';
                                }
                                label += Math.round(value * 100) / 100;
                                return label;
                            }
                        }
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    },
                    scales: {
                        xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Month'
                            },
                            ticks: {
                                min: 1,
                                max: 12,
                            }
                
                        }],
                        yAxes: [{
                            display: true,
                            ticks: {
                                suggestedMin: 0,
                            }
                        }]
                    }
                },
            })
        }

        let drawFieldGraph = (field, data) => {
            return new Promise ((resolve, reject) => {
                for (year in data){
                    values = data[year]["values"]
                    var graphItems = new Array(12).fill(0) 
                    for (var key in data[year]["values"]){
                        graphItems[values[key][0] - 1] = values[key][1]

                    }
                    var ctx = document.getElementById(`${field}_${year}_visualization`).getContext('2d')
                    drawGraph(ctx, graphItems)
                }
            })
        }

        var stat_data = JSON.parse('{{ stat_data|js }}')
        const promiseArray = []
        for (var field in stat_data) {
            promiseArray.push(drawFieldGraph(field,stat_data[field]))
        }
        const drawGraphs = async() => {
            await Promise.all(promiseArray)
        }
        drawGraphs()
    })
</script>
{% endblock content %}